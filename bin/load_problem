#!/bin/bash

set -e

EXEC_NAME="$0"

usage() {
cat << END 1>&2
Usage:
    $EXEC_NAME -h
    $EXEC_NAME [OPTIONS] <short_name>

Description:
    Upload problem from <short_name> directory into DOMjudge.

Options:
    -h                 Prints this message.
END
}

while getopts ":h" arg; do
    case "${arg}" in
        "h")
            usage
            exit 0
            ;;

        *)
            usage
            exit 1
            ;;
    esac
done
shift $(($OPTIND - 1))

short_name="$1"

if [ -z "$short_name" ]; then
    echo "error: short_name not set" 1>&2
    usage
    exit 1
fi

# Remove trailing slash:
short_name="${short_name%/}"

# -------------------- Check direcories --------------------
accepted_dir="$short_name/submissions/accepted"
folders=(
    "$short_name/data/sample"
    "$short_name/data/secret"
    "$accepted_dir"
)

for folder in "${folders[@]}"; do
    if [ ! -d "$folder" ]; then
        echo "Directory $folder does not exist." 1>&2
        exit 1
    fi
done

# -------------------- Check files --------------------
files=(
    "$short_name/problem.yaml"
    "$short_name/domjudge-problem.ini"
)

for file in "${files[@]}"; do
    if [ ! -f "$file" ]; then
        echo "File $file does not exist." 1>&2
        exit 1
    fi
done

# -------------------- Check problem file --------------------
problem_files=(
    "$short_name/problem.html"
    "$short_name/problem.pdf"
    "$short_name/problem.txt"
)

problem_file_exists=false
for problem_file in "${problem_files[@]}"; do
    if [ -f "$problem_file" ]; then
        problem_file_exists=true
        break
    fi
done

if [ "$problem_file_exists" = false ]; then
    echo "None of files $(echo "${problem_files[@]}" | sed 's/ /, /g') exists" 1>&2
    exit 1
fi

# -------------------- Check accepted solution --------------------
if [ -z "$(ls -A "$accepted_dir")" ]; then
    echo "$accepted_dir is empty" 1>&2
    exit 1
fi

# -------------------- Upload --------------------
7z a "$short_name.zip" "$(realpath "$short_name")/*" > /dev/null
