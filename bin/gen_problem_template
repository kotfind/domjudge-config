#!/bin/bash

set -e

EXEC_NAME="$0"

usage() {
cat << END 1>&2
Usage:
    $EXEC_NAME -h
    $EXEC_NAME [OPTIONS] <short_name> <long_name>

Description:
    Generates a template for a problem.
    <long_name> is full name of a problem. Ex. "My Problem"
    <short_name> is usualy a single upper-case letter. Ex. "A"
    Result is stored in <short_name> directory.

Options:
    -h                 Prints this message.
    -s <samples_num>   Sets number of samples. Default: 1
    -S <secrets_num>   Sets number of secrets. Default: 1
    -t <time_limit>    Sets time limit in seconds. Default: 1
    -m <memory_limit>  Sets memory limit in kilobytes. Default: 1024
    -T                 Generates Typst template in <short_name>/problem.typ
END
}

samples_num=1
secrets_num=1
time_limit=1
memory_limit=1024
gen_typst_template=false

while getopts ":hs:S:t:m:T" arg; do
    case "${arg}" in
        "h")
            usage
            exit 0
            ;;

        "s")
            samples_num="$OPTARG"
            ;;

        "S")
            secrets_num="$OPTARG"
            ;;

        "t")
            time_limit="$OPTARG"
            ;;

        "m")
            memory_limit="$OPTARG"
            ;;

        "T")
            gen_typst_template=true
            ;;

        *)
            usage
            exit 1
            ;;
    esac
done
shift $(($OPTIND - 1))

short_name="$1"
long_name="$2"

if [ -z "$short_name" ] || [ -z "$long_name" ]; then
    usage
    exit 1
fi

# -------------------- Metadata --------------------
mkdir -p "$short_name"

cat << END > "$short_name/problem.yaml"
name: "$long_name"
limits:
    memory: $memory_limit
END

cat << END > "$short_name/domjudge-problem.ini"
timelimit = $time_limit
END

# -------------------- Problem --------------------

if [ "$gen_typst_template" = true ]; then
cat << END > "$short_name/problem.typ"
= Задача $short_name. $long_name

== Формат ввода

== Формат вывода

== Примеры
#table(
    columns: (50%, 50%),
    [*Ввод*], [*Вывод*],
    \`\`, \`\`,
)
END
fi

# -------------------- Samples --------------------

sample_dir="$short_name/data/sample"
mkdir -p "$sample_dir"
for i in $(seq 1 $samples_num); do
    touch "$sample_dir/$i.in"
    touch "$sample_dir/$i.ans"
done

secret_dir="$short_name/data/secret"
mkdir -p "$secret_dir"
for i in $(seq 1 $secrets_num); do
    touch "$secret_dir/$i.in"
    touch "$secret_dir/$i.ans"
done

# -------------------- Submissions --------------------
submissions_dir="$short_name/submissions"
accepted_dir="$submissions_dir/accepted"

mkdir -p "$submissions_dir"
mkdir -p "$accepted_dir"

# -------------------- Message --------------------
cat << END
All Done!

Please update ALL following directories:
    $sample_dir/
    $secret_dir/
    $accepted_dir/

Please create ONE following files:
    $short_name/problem.pdf
    $short_name/problem.html
    $short_name/problem.txt
END
